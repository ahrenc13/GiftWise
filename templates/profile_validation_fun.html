<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet {{ recipient_name }} - Giftwise</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* --- Unified card --- */
        .card {
            background: white;
            border-radius: 20px;
            padding: 28px 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* --- Persona summary --- */
        .persona-header {
            text-align: center;
            margin-bottom: 8px;
        }
        .persona-header h2 {
            font-size: 26px;
            color: #333;
            margin-bottom: 4px;
        }
        .persona-header .subtitle {
            font-size: 14px;
            color: #888;
        }

        .persona-summary {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 14px;
            padding: 24px 28px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
            line-height: 1.7;
            font-size: 15px;
            color: #444;
        }
        .persona-summary strong { color: #333; }
        .persona-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 14px;
        }
        .persona-tag {
            display: inline-block;
            background: white;
            border: 1px solid #e0e0e0;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
        }
        .persona-tag.style { border-color: #667eea; color: #667eea; }
        .persona-tag.location { border-color: #10b981; color: #065f46; }
        .persona-tag.brand { border-color: #8b5cf6; color: #5b21b6; }

        /* --- Top CTA --- */
        .top-cta {
            text-align: center;
            padding: 16px 0 8px 0;
        }
        .top-cta p {
            color: #888;
            font-size: 13px;
            margin-top: 10px;
        }

        /* --- Accordion sections --- */
        .accordion-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 14px 18px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            user-select: none;
            transition: all 0.2s;
            margin-bottom: 0;
        }
        .accordion-toggle:hover { background: #f0f2f5; }
        .accordion-toggle .emoji { font-size: 22px; }
        .accordion-toggle .chevron { transition: transform 0.3s; font-size: 12px; margin-left: auto; color: #999; }
        .accordion-toggle.open .chevron { transform: rotate(90deg); }
        .accordion-body { display: none; padding: 16px 0 0 0; }
        .accordion-body.open { display: block; }

        /* --- Divider --- */
        .divider {
            height: 1px;
            background: #e5e7eb;
            margin: 20px 0;
        }

        /* --- Vibe cards (interests) --- */
        .vibe-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }
        .vibe-card:hover { transform: translateY(-2px); }
        .vibe-title { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
        .vibe-description { font-size: 14px; opacity: 0.95; line-height: 1.5; }

        .vibe-tags { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
        .tag {
            background: rgba(255,255,255,0.25);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        .tag.work { background: rgba(255,87,108,0.3); }
        .tag.active { background: rgba(76,217,100,0.3); }

        .confidence-indicator {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 6px;
        }
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }

        .correction-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }

        /* --- Inline edit forms --- */
        .edit-inline {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            display: none;
        }
        .edit-inline.active { display: block; }
        .edit-inline input, .edit-inline textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .edit-inline textarea { min-height: 60px; resize: vertical; }

        /* --- Add interest form --- */
        .add-interest-form {
            display: none;
            margin-top: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        .add-interest-form label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 4px; }
        .add-interest-form input, .add-interest-form textarea {
            width: 100%;
            max-width: 320px;
            padding: 8px 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        .add-interest-form textarea { min-height: 60px; }

        /* --- Add keywords section --- */
        .add-keywords {
            margin-top: 16px;
        }
        .add-keywords-label {
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
        }
        .keyword-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .keyword-input-row input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }
        .keyword-input-row input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }
        .keyword-input-row input::placeholder { color: #bbb; }
        .added-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        .keyword-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            color: #4338ca;
        }
        .keyword-chip .remove-keyword {
            cursor: pointer;
            font-size: 14px;
            color: #999;
            line-height: 1;
        }
        .keyword-chip .remove-keyword:hover { color: #ef4444; }

        /* --- Quick facts (compact rows) --- */
        .quick-facts {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px 20px;
        }
        .fact-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            gap: 8px;
        }
        .fact-row:last-child { border-bottom: none; }
        .fact-icon { font-size: 22px; flex-shrink: 0; }
        .fact-label { font-weight: 600; color: #667eea; font-size: 14px; }
        .fact-value { color: #333; flex: 1; font-size: 14px; }

        /* Inline fact edit */
        .fact-edit {
            display: none;
            width: 100%;
            margin-top: 6px;
        }
        .fact-edit.active { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .fact-edit input {
            flex: 1;
            min-width: 180px;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
        }
        .fact-edit input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }

        /* Location autocomplete */
        .location-input-wrap { position: relative; flex: 1; min-width: 200px; max-width: 320px; }
        .location-input-wrap input { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
        .location-input-wrap input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }
        .location-autocomplete { position: absolute; left: 0; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10; max-height: 220px; overflow-y: auto; }
        .location-autocomplete li { list-style: none; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: #333; }
        .location-autocomplete li:last-child { border-bottom: none; }
        .location-autocomplete li:hover { background: #f0f4ff; }
        .location-hint { font-size: 12px; color: #888; margin-top: 4px; }

        /* --- Gift strategy (compact) --- */
        .gift-strategy { display: flex; flex-direction: column; gap: 8px; }
        .strategy-block {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .strategy-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
        .strategy-hint { font-size: 13px; color: #888; }

        /* --- Intel report (collapsible) --- */
        .intel-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 16px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #a0e7ff;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            user-select: none;
            transition: all 0.2s;
        }
        .intel-toggle:hover { background: linear-gradient(135deg, #16213e 0%, #0f3460 100%); }
        .intel-toggle .chevron { transition: transform 0.3s; font-size: 12px; margin-left: auto; }
        .intel-toggle.open .chevron { transform: rotate(90deg); }
        .intel-body { display: none; padding: 16px 0 0 0; }
        .intel-body.open { display: block; }

        .intel-card {
            background: #f0f4ff;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }
        .intel-card-title { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .intel-card-body { font-size: 13px; color: #555; line-height: 1.5; }

        .intel-tag { display: inline-block; background: white; border: 1px solid #ddd; padding: 3px 10px; border-radius: 14px; font-size: 12px; margin: 2px 3px; color: #444; }
        .intel-tag.good { border-color: #10b981; color: #065f46; background: #ecfdf5; }
        .intel-tag.bad { border-color: #ef4444; color: #991b1b; background: #fef2f2; }
        .intel-tag.trend { border-color: #8b5cf6; color: #5b21b6; background: #f5f3ff; }

        .intel-interest-row {
            cursor: pointer;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
            transition: background 0.15s;
        }
        .intel-interest-row:hover { background: #f8faff; }
        .intel-interest-name { font-weight: 600; font-size: 14px; color: #333; }
        .intel-interest-detail { display: none; padding-top: 8px; margin-top: 8px; border-top: 1px solid #f0f0f0; }
        .intel-interest-detail.open { display: block; }
        .intel-detail-label { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 6px; margin-bottom: 3px; }

        /* --- Buttons --- */
        button {
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.small { padding: 6px 12px; font-size: 12px; }

        button.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 36px;
            font-size: 18px;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
        }
        button.primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(16, 185, 129, 0.45);
        }

        button.secondary {
            background: transparent;
            color: #666;
            padding: 10px 16px;
            font-size: 13px;
            border: 1px solid #ccc;
        }
        button.secondary:hover { background: #f5f5f5; color: #333; border-color: #999; }

        button.secondary.small { background: #f0f0f0; color: #555; border: 1px solid #ddd; }
        button.secondary.small:hover { background: #e5e5e5; }

        button.small.work-toggle { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        button.small.work-toggle:hover { background: #a7f3d0; }

        button.keyword-add {
            background: #667eea;
            color: white;
            padding: 10px 18px;
            font-size: 14px;
            border-radius: 10px;
            white-space: nowrap;
        }
        button.keyword-add:hover { background: #5a6fd6; }

        /* --- CTA bar --- */
        .cta-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            align-items: center;
            padding: 20px 0 0 0;
        }

        @media (max-width: 600px) {
            .card { padding: 20px 16px; }
            .persona-summary { padding: 18px 16px; }
            .persona-header h2 { font-size: 22px; }
            .accordion-toggle { font-size: 15px; padding: 12px 14px; }
            .fact-row { flex-direction: column; align-items: flex-start; }
            .keyword-input-row { flex-direction: column; }
            .keyword-input-row input { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        {% set pronoun_possessive = 'your' if recipient_name == 'You' else 'their' %}
        {% set pronoun_subject = 'you' if recipient_name == 'You' else 'they' %}
        {% set pronoun_object = 'you' if recipient_name == 'You' else 'them' %}

        <!-- ===== CARD 1: Persona summary + top CTA ===== -->
        <div class="card">
            <div class="persona-header">
                {% if recipient_name == 'You' %}
                <h2>Here's What We See</h2>
                <div class="subtitle">Based on your social media activity</div>
                {% else %}
                <h2>Meet {{ recipient_name }}</h2>
                <div class="subtitle">Based on {{ pronoun_possessive }} social media activity</div>
                {% endif %}
            </div>

            <!-- Synthesized persona summary -->
            <div class="persona-summary" id="persona-summary">
                <!-- Filled by JS from profile data for richer synthesis -->
            </div>

            <!-- Top CTA -->
            <div class="top-cta">
                {% if recipient_name == 'You' %}
                <button class="primary" onclick="approveProfile()">Looks right — show me ideas</button>
                <p>Or scroll down to review and tweak what we found</p>
                {% else %}
                <button class="primary" onclick="approveProfile()">I trust you — find my gifts</button>
                <p>Or scroll down to review and tweak what we found</p>
                {% endif %}
            </div>
        </div>

        <!-- ===== CARD 2: Interests (accordion) + Add keywords ===== -->
        <div class="card">
            <!-- Interests accordion -->
            <div class="accordion-toggle" onclick="toggleAccordion('interests')" id="interests-toggle">
                <span class="emoji">&#10024;</span>
                <span>Interests we found — expand to review &amp; edit</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="accordion-body" id="interests-body">
                {% for interest in interests %}
                <div class="vibe-card" data-interest-id="{{ loop.index0 }}">
                    <div class="vibe-title">{{ interest.name }}</div>
                    <div class="vibe-description">{{ interest.description }}</div>
                    <div class="vibe-tags">
                        {% if interest.is_work %}
                        <span class="tag work">&#x1F3E2; Work (won't suggest gifts)</span>
                        {% endif %}
                        {% if interest.activity_type == 'active' %}
                        <span class="tag active">&#x1F3C3; Does This</span>
                        {% else %}
                        <span class="tag">&#x1F440; Watches/Enjoys</span>
                        {% endif %}
                        {% if interest.confidence %}
                        <span class="confidence-indicator confidence-{{ 'high' if interest.confidence > 0.7 else 'medium' }}">
                            {{ (interest.confidence * 100) | int }}% sure
                        </span>
                        {% endif %}
                    </div>
                    <div class="correction-buttons">
                        <button class="small secondary" onclick="editInterest({{ loop.index0 }})">&#9999;&#65039; Edit</button>
                        <button class="small secondary" onclick="removeInterest({{ loop.index0 }})">&#10060; Remove</button>
                        {% if interest.is_work %}
                        <button class="small work-toggle" onclick="toggleWork({{ loop.index0 }})">Mark as hobby</button>
                        {% else %}
                        <button class="small secondary" onclick="toggleWork({{ loop.index0 }})">Mark as work</button>
                        {% endif %}
                    </div>
                    <div class="edit-inline" id="edit-{{ loop.index0 }}">
                        <input type="text" id="name-{{ loop.index0 }}" value="{{ interest.name }}" placeholder="Interest name">
                        <textarea id="desc-{{ loop.index0 }}" placeholder="What {{ pronoun_subject }} like about it">{{ interest.description }}</textarea>
                        <button class="small" onclick="saveEdit({{ loop.index0 }})">Save</button>
                        <button class="small secondary" onclick="cancelEdit({{ loop.index0 }})">Cancel</button>
                    </div>
                </div>
                {% endfor %}

                <div id="add-interest-form" class="add-interest-form">
                    <label>Interest name</label>
                    <input type="text" id="new-interest-name" placeholder="e.g. Vintage vinyl">
                    <label>What do {{ pronoun_subject }} like about it? (optional)</label>
                    <textarea id="new-interest-desc" placeholder="e.g. Collects 70s rock"></textarea>
                    <label>Is this related to {{ pronoun_possessive }} job?</label>
                    <div style="margin-bottom: 10px;">
                        <label style="margin-right: 16px; font-weight: normal;"><input type="radio" name="new-interest-work" id="new-interest-work-no" value="no" checked> No, hobby</label>
                        <label style="font-weight: normal;"><input type="radio" name="new-interest-work" id="new-interest-work-yes" value="yes"> Yes, work</label>
                    </div>
                    <label>Do {{ pronoun_subject }} actively do this?</label>
                    <div style="margin-bottom: 12px;">
                        <label style="margin-right: 16px; font-weight: normal;"><input type="radio" name="new-interest-active" id="new-interest-active-yes" value="yes" checked> Yes</label>
                        <label style="font-weight: normal;"><input type="radio" name="new-interest-active" id="new-interest-active-no" value="no"> No, {{ pronoun_subject }} watch/enjoy</label>
                    </div>
                    <button type="button" class="small primary" onclick="submitAddInterest()" style="padding: 8px 16px; font-size: 13px;">Add to profile</button>
                    <button type="button" class="small secondary" onclick="cancelAddInterest()" style="margin-left: 6px;">Cancel</button>
                </div>
                <div id="add-interest-btn-wrap">
                    <button class="secondary" onclick="showAddInterestForm()" style="margin-top: 12px;">+ Add Something We Missed</button>
                </div>
            </div>

            <!-- Add keywords/interests -->
            <div class="divider"></div>
            <div class="add-keywords">
                <div class="add-keywords-label">Have something specific in mind? Add keywords to guide our search.</div>
                <div class="keyword-input-row">
                    <input type="text" id="keyword-input" placeholder="e.g. camping gear, board games, espresso..." onkeydown="if(event.key==='Enter'){addKeyword();}">
                    <button class="keyword-add" onclick="addKeyword()">+ Add</button>
                </div>
                <div class="added-keywords" id="added-keywords"></div>
            </div>
        </div>

        <!-- ===== CARD 3: Quick Facts (accordion) ===== -->
        <div class="card">
            <div class="accordion-toggle" onclick="toggleAccordion('facts')" id="facts-toggle">
                <span class="emoji">&#x1F4CB;</span>
                <span>About {{ recipient_name }}</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="accordion-body" id="facts-body">
                <div class="quick-facts">
                    <!-- Location -->
                    <div class="fact-row" id="location-row">
                        <span class="fact-icon">&#x1F30E;</span>
                        <span class="fact-label">Location:</span>
                        <span class="fact-value" id="location-display" style="{% if not profile.location_context or not profile.location_context.city_region %}display: none;{% endif %}">{% if profile.location_context and profile.location_context.city_region %}{{ profile.location_context.city_region }}{% if profile.location_context.state %}, {{ profile.location_context.state }}{% endif %}{% endif %}</span>
                        <div class="location-input-wrap" id="location-edit-wrap" style="display: {% if profile.location_context and profile.location_context.city_region %}none{% else %}block{% endif %};">
                            <input type="text" id="location-input" placeholder="Start typing a city..." autocomplete="off" value="{{ profile.location_context.city_region or '' }}">
                            <ul class="location-autocomplete" id="location-autocomplete" style="display: none;"></ul>
                            <span class="location-hint">Helps us suggest local experiences</span>
                        </div>
                        <button class="small secondary" id="location-edit-btn" onclick="editLocation()" style="{% if not profile.location_context or not profile.location_context.city_region %}display: none;{% endif %}">Edit</button>
                    </div>

                    <!-- Style -->
                    {% if profile.style_preferences and profile.style_preferences.visual_style %}
                    <div class="fact-row" id="style-row">
                        <span class="fact-icon">&#x1F3A8;</span>
                        <span class="fact-label">Style:</span>
                        <span class="fact-value" id="style-display">{{ profile.style_preferences.visual_style }}{% if profile.style_preferences.quality_level %} &middot; {{ profile.style_preferences.quality_level }}{% endif %}</span>
                        <button class="small secondary" onclick="toggleFactEdit('style')">Edit</button>
                        <div class="fact-edit" id="style-edit">
                            <input type="text" id="style-input" value="{{ profile.style_preferences.visual_style or '' }}" placeholder="e.g. minimalist, boho, classic">
                            <button class="small" onclick="saveFactEdit('style')">Save</button>
                            <button class="small secondary" onclick="cancelFactEdit('style')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Brands -->
                    {% if profile.style_preferences and profile.style_preferences.brands %}
                    <div class="fact-row" id="brands-row">
                        <span class="fact-icon">&#x1F3F7;&#xFE0F;</span>
                        <span class="fact-label">Brands:</span>
                        <span class="fact-value" id="brands-display">{{ profile.style_preferences.brands | join(', ') }}</span>
                        <button class="small secondary" onclick="toggleFactEdit('brands')">Edit</button>
                        <div class="fact-edit" id="brands-edit">
                            <input type="text" id="brands-input" value="{{ profile.style_preferences.brands | join(', ') }}" placeholder="Comma-separated brands">
                            <button class="small" onclick="saveFactEdit('brands')">Save</button>
                            <button class="small secondary" onclick="cancelFactEdit('brands')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Budget -->
                    {% if profile.price_signals and (profile.price_signals.estimated_range or profile.price_signals.budget_category) %}
                    <div class="fact-row" id="budget-row">
                        <span class="fact-icon">&#x1F4B0;</span>
                        <span class="fact-label">Budget:</span>
                        <span class="fact-value" id="budget-display">{{ profile.price_signals.estimated_range or '' }}{% if profile.price_signals.budget_category %} ({{ profile.price_signals.budget_category }}){% endif %}</span>
                        <button class="small secondary" onclick="toggleFactEdit('budget')">Edit</button>
                        <div class="fact-edit" id="budget-edit">
                            <input type="text" id="budget-input" value="{{ profile.price_signals.estimated_range or '' }}" placeholder="e.g. $25-75">
                            <button class="small" onclick="saveFactEdit('budget')">Save</button>
                            <button class="small secondary" onclick="cancelFactEdit('budget')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Pet -->
                    {% if profile.pet_details %}
                    <div class="fact-row" id="pet-row">
                        <span class="fact-icon">&#x1F43E;</span>
                        <span class="fact-label">Pet:</span>
                        <span class="fact-value" id="pet-display">{{ profile.pet_details }}</span>
                        <button class="small secondary" onclick="toggleFactEdit('pet')">Edit</button>
                        <div class="fact-edit" id="pet-edit">
                            <input type="text" id="pet-input" value="{{ profile.pet_details or '' }}" placeholder="e.g. Golden retriever named Max">
                            <button class="small" onclick="saveFactEdit('pet')">Save</button>
                            <button class="small secondary" onclick="cancelFactEdit('pet')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Family -->
                    {% if profile.family_context %}
                    <div class="fact-row" id="family-row">
                        <span class="fact-icon">&#x1F468;&#x200D;&#x1F469;&#x200D;&#x1F467;&#x200D;&#x1F466;</span>
                        <span class="fact-label">Family:</span>
                        <span class="fact-value" id="family-display">{{ profile.family_context }}</span>
                        <button class="small secondary" onclick="toggleFactEdit('family')">Edit</button>
                        <div class="fact-edit" id="family-edit">
                            <input type="text" id="family-input" value="{{ profile.family_context or '' }}" placeholder="e.g. Married, 2 kids">
                            <button class="small" onclick="saveFactEdit('family')">Save</button>
                            <button class="small secondary" onclick="cancelFactEdit('family')">Cancel</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Venues -->
                    {% if profile.specific_venues %}
                    <div class="fact-row">
                        <span class="fact-icon">&#x1F4CD;</span>
                        <span class="fact-label">Hangouts:</span>
                        <span class="fact-value">{{ profile.specific_venues | map(attribute='name') | select('string') | join(', ') }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if gift_strategy %}
                <div class="divider"></div>
                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">&#x1F381;</span> Gift Strategy
                </div>
                <div class="gift-strategy">
                    {{ gift_strategy | safe }}
                </div>
                {% endif %}
            </div>
        </div>

        {% if intel_report %}
        <!-- ===== CARD 4: Intelligence Report (collapsible) ===== -->
        <div class="card">
            <div class="intel-toggle" onclick="toggleIntel()" id="intel-toggle">
                <span>&#x1F52C;</span>
                <span>Under the Hood — Our Analysis</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="intel-body" id="intel-body">

                {% if intel_report.sources %}
                <div class="intel-card">
                    <div class="intel-card-title">&#x1F4CA; Data Sources</div>
                    <div class="intel-card-body">
                        {% for src in intel_report.sources %}
                        <div style="margin-bottom: 4px;">{{ src }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if intel_report.demographic %}
                <div class="intel-card">
                    <div class="intel-card-title">&#x1F464; Demographic Insight</div>
                    <div class="intel-card-body">
                        {% if intel_report.demographic.gift_style %}
                        <div>Gift style: <strong>{{ intel_report.demographic.gift_style }}</strong></div>
                        {% endif %}
                        {% if intel_report.demographic.popular_categories %}
                        <div style="margin-top: 6px;">Trending for this demo:
                            {% for cat in intel_report.demographic.popular_categories %}<span class="intel-tag trend">{{ cat }}</span>{% endfor %}
                        </div>
                        {% endif %}
                        {% if intel_report.demographic.avoid %}
                        <div style="margin-top: 6px;">Skip for this demo:
                            {% for a in intel_report.demographic.avoid %}<span class="intel-tag bad">{{ a }}</span>{% endfor %}
                        </div>
                        {% endif %}
                        {% if intel_report.demographic.price_preference %}
                        <div style="margin-top: 6px;">Typical budget: ${{ intel_report.demographic.price_preference[0] }}–${{ intel_report.demographic.price_preference[1] }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if intel_report.cross_platform %}
                <div class="intel-card">
                    <div class="intel-card-title">&#x1F517; Cross-Platform Signals</div>
                    <div class="intel-card-body">
                        {% if intel_report.cross_platform.brands %}
                        <div>Brands detected: {% for b in intel_report.cross_platform.brands %}<span class="intel-tag">{{ b }}</span>{% endfor %}</div>
                        {% endif %}
                        {% if intel_report.cross_platform.music %}
                        <div style="margin-top: 6px;">Music taste: {% for m in intel_report.cross_platform.music %}<span class="intel-tag">{{ m }}</span>{% endfor %}</div>
                        {% endif %}
                        {% if intel_report.cross_platform.aspirational %}
                        <div style="margin-top: 6px;">Aspiring to: {% for a in intel_report.cross_platform.aspirational %}<span class="intel-tag good">{{ a }}</span>{% endfor %}</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if intel_report.interest_intel %}
                <div class="intel-card" style="border-left-color: #8b5cf6;">
                    <div class="intel-card-title">&#x1F9E0; Per-Interest Intelligence</div>
                    <div class="intel-card-body">
                        {% for ii in intel_report.interest_intel %}
                        <div class="intel-interest-row" onclick="toggleInterestIntel(this)">
                            <div class="intel-interest-name">{{ ii.name }} <span class="chevron" style="font-size: 10px; color: #999;">&#9654;</span></div>
                            <div class="intel-interest-detail">
                                {% if ii.search_terms %}
                                <div class="intel-detail-label">Search Strategy</div>
                                <div>{% for t in ii.search_terms %}<span class="intel-tag">{{ t }}</span>{% endfor %}</div>
                                {% endif %}
                                {% if ii.do_buy %}
                                <div class="intel-detail-label">Good Gift Types</div>
                                <div>{% for d in ii.do_buy %}<span class="intel-tag good">{{ d }}</span>{% endfor %}</div>
                                {% endif %}
                                {% if ii.dont_buy %}
                                <div class="intel-detail-label">Avoid</div>
                                <div>{% for d in ii.dont_buy %}<span class="intel-tag bad">{{ d }}</span>{% endfor %}</div>
                                {% endif %}
                                {% if ii.trending %}
                                <div class="intel-detail-label">Trending 2026</div>
                                <div>{% for t in ii.trending %}<span class="intel-tag trend">{{ t }}</span>{% endfor %}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if intel_report.quality_filters %}
                <div class="intel-card" style="border-left-color: #ef4444;">
                    <div class="intel-card-title">&#x1F6E1;&#xFE0F; Quality Filters Active</div>
                    <div class="intel-card-body">
                        {% for f in intel_report.quality_filters %}<span class="intel-tag bad">{{ f }}</span>{% endfor %}
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
        {% endif %}

        <!-- ===== Bottom CTA ===== -->
        <div class="card">
            <div style="text-align: center; padding: 4px 0;">
                {% if recipient_name == 'You' %}
                <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Look good? Let's find some things you'll love.</p>
                {% else %}
                <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Happy with the profile? Let's find the perfect gifts.</p>
                {% endif %}
                <div class="cta-bar">
                    <button class="secondary" onclick="window.location.href='/connect-platforms'">&larr; Back to platforms</button>
                    <button class="primary" onclick="approveProfile()">
                        {% if recipient_name == 'You' %}Show me ideas &rarr;{% else %}Find my gifts &rarr;{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let profileData = {{ profile_json | safe }};
        let generationId = "{{ generation_id }}";
        let pronounPossessive = "{{ pronoun_possessive }}";
        let pronounSubject = "{{ pronoun_subject }}";
        let addedKeywords = [];

        // --- Build persona summary from profile data ---
        (function buildPersonaSummary() {
            var el = document.getElementById('persona-summary');
            if (!el) return;

            var interests = (profileData.interests || []).filter(function(i) { return !i.is_work; });
            var topInterests = interests.slice(0, 4).map(function(i) { return i.name; });
            var location = (profileData.location_context && profileData.location_context.city_region) || '';
            var style = (profileData.style_preferences && profileData.style_preferences.visual_style) || '';
            var brands = (profileData.style_preferences && profileData.style_preferences.brands) || [];
            var quality = (profileData.style_preferences && profileData.style_preferences.quality_level) || '';

            // Build natural language summary
            var parts = [];
            var name = "{{ recipient_name }}";
            var isYou = name === 'You';
            var subj = isYou ? 'You' : name;
            var verb = isYou ? "'re" : ' is';
            var poss = isYou ? 'your' : 'their';

            if (topInterests.length > 0) {
                var interestStr;
                if (topInterests.length === 1) {
                    interestStr = '<strong>' + escapeHtml(topInterests[0]) + '</strong>';
                } else if (topInterests.length === 2) {
                    interestStr = '<strong>' + escapeHtml(topInterests[0]) + '</strong> and <strong>' + escapeHtml(topInterests[1]) + '</strong>';
                } else {
                    var last = topInterests.pop();
                    interestStr = topInterests.map(function(i) { return '<strong>' + escapeHtml(i) + '</strong>'; }).join(', ') + ', and <strong>' + escapeHtml(last) + '</strong>';
                }
                parts.push(subj + verb + ' really into ' + interestStr + '.');
            }

            if (location) {
                parts.push((isYou ? 'Based' : 'Based') + ' in <strong>' + escapeHtml(location) + '</strong>.');
            }

            if (style) {
                parts.push((isYou ? 'Your' : 'Their') + ' style leans <strong>' + escapeHtml(style) + '</strong>' + (quality ? ' with ' + escapeHtml(quality) + ' taste' : '') + '.');
            }

            if (interests.length > 4) {
                var moreCount = interests.length - 4;
                parts.push('Plus ' + moreCount + ' more interest' + (moreCount > 1 ? 's' : '') + ' we spotted.');
            }

            if (parts.length === 0) {
                parts.push("We found some interesting things about " + (isYou ? "you" : name) + " from " + poss + " social media.");
            }

            el.innerHTML = parts.join(' ');

            // Add tags
            var tagsHtml = '';
            if (location) {
                tagsHtml += '<span class="persona-tag location">' + escapeHtml(location) + '</span>';
            }
            if (style) {
                tagsHtml += '<span class="persona-tag style">' + escapeHtml(style) + '</span>';
            }
            brands.slice(0, 5).forEach(function(b) {
                tagsHtml += '<span class="persona-tag brand">' + escapeHtml(b) + '</span>';
            });
            if (tagsHtml) {
                el.innerHTML += '<div class="persona-tags">' + tagsHtml + '</div>';
            }
        })();

        // --- Accordion ---
        function toggleAccordion(section) {
            var toggle = document.getElementById(section + '-toggle');
            var body = document.getElementById(section + '-body');
            if (!toggle || !body) return;
            toggle.classList.toggle('open');
            body.classList.toggle('open');
        }

        // --- Interest editing ---
        function editInterest(index) {
            document.getElementById('edit-' + index).classList.add('active');
        }
        function cancelEdit(index) {
            document.getElementById('edit-' + index).classList.remove('active');
        }
        function saveEdit(index) {
            const name = document.getElementById('name-' + index).value.trim();
            const desc = document.getElementById('desc-' + index).value.trim();
            if (!name) return;
            profileData.interests[index].name = name;
            profileData.interests[index].description = desc;
            const card = document.querySelector('[data-interest-id="' + index + '"]');
            if (card) {
                card.querySelector('.vibe-title').textContent = name;
                card.querySelector('.vibe-description').textContent = desc || (pronounSubject === 'you' ? "You're into " + name : "They're into " + name);
            }
            cancelEdit(index);
        }

        function toggleWork(index) {
            profileData.interests[index].is_work = !profileData.interests[index].is_work;
            const card = document.querySelector('[data-interest-id="' + index + '"]');
            if (!card) return;
            const tags = card.querySelector('.vibe-tags');
            const workTag = card.querySelector('.tag.work');
            const toggleBtn = card.querySelector('.work-toggle') || Array.prototype.find.call(card.querySelectorAll('button'), function(b) { return b.textContent.indexOf('Mark as') !== -1; });
            if (profileData.interests[index].is_work) {
                if (!workTag && tags) {
                    const span = document.createElement('span');
                    span.className = 'tag work';
                    span.textContent = '\u{1F3E2} Work (won\'t suggest gifts)';
                    tags.insertBefore(span, tags.firstChild);
                }
                if (toggleBtn) { toggleBtn.textContent = "Mark as hobby"; toggleBtn.className = 'small work-toggle'; }
            } else {
                if (workTag) workTag.remove();
                if (toggleBtn) { toggleBtn.textContent = "Mark as work"; toggleBtn.className = 'small secondary'; }
            }
        }

        function removeInterest(index) {
            if (!confirm('Remove this from ' + pronounPossessive + ' profile?')) return;
            profileData.interests.splice(index, 1);
            var card = document.querySelector('[data-interest-id="' + index + '"]');
            if (card) card.remove();
            var cards = document.querySelectorAll('.vibe-card[data-interest-id]');
            for (var i = 0; i < cards.length; i++) {
                cards[i].setAttribute('data-interest-id', i);
                var editDiv = cards[i].querySelector('.edit-inline');
                if (editDiv) {
                    editDiv.id = 'edit-' + i;
                    var inp = editDiv.querySelector('input[id^="name-"]');
                    var ta = editDiv.querySelector('textarea[id^="desc-"]');
                    if (inp) inp.id = 'name-' + i;
                    if (ta) ta.id = 'desc-' + i;
                }
                cards[i].querySelectorAll('button').forEach(function(btn) {
                    var on = btn.getAttribute('onclick');
                    if (!on) return;
                    on = on.replace(/editInterest\(\d+\)/, 'editInterest(' + i + ')').replace(/removeInterest\(\d+\)/, 'removeInterest(' + i + ')').replace(/toggleWork\(\d+\)/, 'toggleWork(' + i + ')').replace(/saveEdit\(\d+\)/, 'saveEdit(' + i + ')').replace(/cancelEdit\(\d+\)/, 'cancelEdit(' + i + ')');
                    btn.setAttribute('onclick', on);
                });
            }
        }

        // --- Add interest ---
        function showAddInterestForm() {
            document.getElementById('add-interest-form').style.display = 'block';
            document.getElementById('add-interest-btn-wrap').style.display = 'none';
            document.getElementById('new-interest-name').focus();
        }
        function cancelAddInterest() {
            document.getElementById('add-interest-form').style.display = 'none';
            document.getElementById('add-interest-btn-wrap').style.display = 'block';
            document.getElementById('new-interest-name').value = '';
            document.getElementById('new-interest-desc').value = '';
        }
        function submitAddInterest() {
            const name = document.getElementById('new-interest-name').value.trim();
            if (!name) { alert('Please enter an interest name.'); return; }
            const desc = document.getElementById('new-interest-desc').value.trim();
            const isWork = document.getElementById('new-interest-work-yes').checked;
            const isActive = document.getElementById('new-interest-active-yes').checked;
            const newInterest = {
                name: name,
                description: desc || (pronounSubject === 'you' ? "You're into " + name : "They're into " + name),
                is_work: isWork,
                activity_type: isActive ? 'active' : 'passive',
                confidence: 1.0
            };
            profileData.interests.push(newInterest);
            const index = profileData.interests.length - 1;
            const addBtnWrap = document.getElementById('add-interest-btn-wrap');
            const cardHtml = '<div class="vibe-card" data-interest-id="' + index + '">' +
                '<div class="vibe-title">' + escapeHtml(name) + '</div>' +
                '<div class="vibe-description">' + escapeHtml(newInterest.description) + '</div>' +
                '<div class="vibe-tags">' +
                (isWork ? '<span class="tag work">\u{1F3E2} Work (won\'t suggest gifts)</span>' : '') +
                (isActive ? '<span class="tag active">\u{1F3C3} Does This</span>' : '<span class="tag">\u{1F440} Watches/Enjoys</span>') +
                '<span class="confidence-indicator confidence-high">100% sure</span></div>' +
                '<div class="correction-buttons">' +
                '<button class="small secondary" onclick="editInterest(' + index + ')">\u270F\uFE0F Edit</button>' +
                '<button class="small secondary" onclick="removeInterest(' + index + ')">\u274C Remove</button>' +
                (isWork ? '<button class="small work-toggle" onclick="toggleWork(' + index + ')">Mark as hobby</button>' : '<button class="small secondary" onclick="toggleWork(' + index + ')">Mark as work</button>') +
                '</div>' +
                '<div class="edit-inline" id="edit-' + index + '">' +
                '<input type="text" id="name-' + index + '" value="' + escapeHtml(name) + '" placeholder="Interest name">' +
                '<textarea id="desc-' + index + '" placeholder="What ' + pronounSubject + ' like about it">' + escapeHtml(newInterest.description) + '</textarea>' +
                '<button class="small" onclick="saveEdit(' + index + ')">Save</button>' +
                '<button class="small secondary" onclick="cancelEdit(' + index + ')">Cancel</button></div></div>';
            const div = document.createElement('div');
            div.innerHTML = cardHtml;
            addBtnWrap.parentNode.insertBefore(div.firstChild, document.getElementById('add-interest-form'));
            cancelAddInterest();
        }
        function escapeHtml(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // --- Keywords ---
        function addKeyword() {
            var input = document.getElementById('keyword-input');
            var val = input.value.trim();
            if (!val) return;
            // Split on commas to allow multiple at once
            var keywords = val.split(',').map(function(k) { return k.trim(); }).filter(Boolean);
            keywords.forEach(function(kw) {
                if (addedKeywords.indexOf(kw) === -1) {
                    addedKeywords.push(kw);
                }
            });
            input.value = '';
            renderKeywords();
            // Store in profileData for submission
            profileData._extra_keywords = addedKeywords.slice();
        }
        function removeKeyword(index) {
            addedKeywords.splice(index, 1);
            profileData._extra_keywords = addedKeywords.slice();
            renderKeywords();
        }
        function renderKeywords() {
            var container = document.getElementById('added-keywords');
            container.innerHTML = '';
            addedKeywords.forEach(function(kw, i) {
                container.innerHTML += '<span class="keyword-chip">' + escapeHtml(kw) + ' <span class="remove-keyword" onclick="removeKeyword(' + i + ')">&times;</span></span>';
            });
        }

        // --- Quick fact inline editing ---
        function toggleFactEdit(field) {
            var el = document.getElementById(field + '-edit');
            if (!el) return;
            if (el.classList.contains('active')) {
                cancelFactEdit(field);
            } else {
                el.classList.add('active');
                var inp = document.getElementById(field + '-input');
                if (inp) inp.focus();
            }
        }
        function cancelFactEdit(field) {
            var el = document.getElementById(field + '-edit');
            if (el) el.classList.remove('active');
        }
        function saveFactEdit(field) {
            var inp = document.getElementById(field + '-input');
            if (!inp) return;
            var val = inp.value.trim();
            if (!val) return;

            if (field === 'style') {
                if (!profileData.style_preferences) profileData.style_preferences = {};
                profileData.style_preferences.visual_style = val;
                var el = document.getElementById('style-display');
                if (el) el.textContent = val + (profileData.style_preferences.quality_level ? ' \u00B7 ' + profileData.style_preferences.quality_level : '');
            } else if (field === 'brands') {
                if (!profileData.style_preferences) profileData.style_preferences = {};
                profileData.style_preferences.brands = val.split(',').map(function(b) { return b.trim(); }).filter(Boolean);
                var el = document.getElementById('brands-display');
                if (el) el.textContent = profileData.style_preferences.brands.join(', ');
            } else if (field === 'budget') {
                if (!profileData.price_signals) profileData.price_signals = {};
                profileData.price_signals.estimated_range = val;
                var el = document.getElementById('budget-display');
                if (el) el.textContent = val + (profileData.price_signals.budget_category ? ' (' + profileData.price_signals.budget_category + ')' : '');
            } else if (field === 'pet') {
                profileData.pet_details = val;
                var el = document.getElementById('pet-display');
                if (el) el.textContent = val;
            } else if (field === 'family') {
                profileData.family_context = val;
                var el = document.getElementById('family-display');
                if (el) el.textContent = val;
            }
            cancelFactEdit(field);
        }

        // --- Intel report ---
        function toggleIntel() {
            var toggle = document.getElementById('intel-toggle');
            var body = document.getElementById('intel-body');
            toggle.classList.toggle('open');
            body.classList.toggle('open');
        }
        function toggleInterestIntel(row) {
            var detail = row.querySelector('.intel-interest-detail');
            var chevron = row.querySelector('.chevron');
            if (detail) {
                detail.classList.toggle('open');
                if (chevron) chevron.textContent = detail.classList.contains('open') ? '\u25BC' : '\u25B6';
            }
        }

        // --- Location autocomplete ---
        var locationAutocompleteTimer = null;
        function ensureLocationContext() {
            if (!profileData.location_context) profileData.location_context = {};
            if (typeof profileData.location_context.city_region === 'undefined') profileData.location_context.city_region = '';
        }
        ensureLocationContext();

        function showLocationDisplay() {
            document.getElementById('location-display').textContent = profileData.location_context.city_region || '';
            document.getElementById('location-display').style.display = profileData.location_context.city_region ? 'inline' : 'none';
            document.getElementById('location-edit-wrap').style.display = 'none';
            document.getElementById('location-input').value = profileData.location_context.city_region || '';
            var editBtn = document.getElementById('location-edit-btn');
            if (editBtn) editBtn.style.display = profileData.location_context.city_region ? 'inline-block' : 'none';
        }
        function showLocationEdit() {
            document.getElementById('location-display').style.display = 'none';
            document.getElementById('location-edit-wrap').style.display = 'block';
            document.getElementById('location-edit-btn').style.display = 'none';
            document.getElementById('location-input').value = profileData.location_context.city_region || '';
            document.getElementById('location-input').focus();
        }
        function editLocation() { showLocationEdit(); }

        (function initLocationAutocomplete() {
            var input = document.getElementById('location-input');
            var list = document.getElementById('location-autocomplete');
            if (!input || !list) return;

            function fetchSuggestions(q) {
                if (q.length < 2) { list.style.display = 'none'; return; }
                fetch('/api/places-autocomplete?q=' + encodeURIComponent(q))
                    .then(function(r) { return r.json(); })
                    .then(function(items) {
                        list.innerHTML = '';
                        if (!items.length) { list.style.display = 'none'; return; }
                        items.forEach(function(item) {
                            var li = document.createElement('li');
                            li.textContent = item.display;
                            li.onclick = function() {
                                profileData.location_context.city_region = item.city_region;
                                input.value = item.city_region;
                                list.style.display = 'none';
                                showLocationDisplay();
                            };
                            list.appendChild(li);
                        });
                        list.style.display = 'block';
                    })
                    .catch(function() { list.style.display = 'none'; });
            }

            input.addEventListener('input', function() {
                clearTimeout(locationAutocompleteTimer);
                var q = input.value.trim();
                locationAutocompleteTimer = setTimeout(function() { fetchSuggestions(q); }, 220);
            });
            input.addEventListener('focus', function() {
                var q = input.value.trim();
                if (q.length >= 2) fetchSuggestions(q);
            });
            input.addEventListener('blur', function() {
                setTimeout(function() {
                    list.style.display = 'none';
                    var v = input.value.trim();
                    if (v) {
                        profileData.location_context.city_region = v;
                        showLocationDisplay();
                    }
                }, 180);
            });
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !list.contains(e.target)) list.style.display = 'none';
            });
        })();

        // --- Approve profile ---
        async function approveProfile() {
            var isYou = "{{ recipient_name }}" === 'You';
            var btns = document.querySelectorAll('.primary');
            btns.forEach(function(b) { b.disabled = true; b.textContent = isYou ? 'Finding ideas...' : 'Finding gifts...'; });

            var response = await fetch('/api/approve-profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    generation_id: generationId,
                    profile: profileData
                })
            });

            if (response.ok) {
                window.location.href = '/generating?id=' + generationId;
            } else {
                alert('Error saving. Please try again.');
                var resetText = isYou ? 'Show me ideas \u2192' : 'Find my gifts \u2192';
                btns.forEach(function(b) { b.disabled = false; b.textContent = resetText; });
            }
        }
    </script>
</body>
</html>
