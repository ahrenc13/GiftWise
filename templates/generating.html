<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generating Recommendations - Giftwise</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }
        
        .logo {
            font-size: 4em;
            margin-bottom: 30px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        
        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 40px;
        }
        
        .platforms-analyzing {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .platform-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .platform-item:nth-child(1) { animation-delay: 0s; }
        .platform-item:nth-child(2) { animation-delay: 0.2s; }
        .platform-item:nth-child(3) { animation-delay: 0.4s; }
        .platform-item:nth-child(4) { animation-delay: 0.6s; }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            font-size: 1.1em;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: white;
            width: 0% !important;
            transition: width 0.5s ease;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        /* Indeterminate progress bar animation */
        .progress-bar.indeterminate {
            width: 100% !important;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.3) 0%, 
                rgba(255,255,255,0.8) 50%, 
                rgba(255,255,255,0.3) 100%);
            background-size: 200% 100%;
            animation: indeterminate-progress 2s linear infinite;
        }
        
        @keyframes indeterminate-progress {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .quote-message {
            font-size: 0.95em;
            opacity: 0;
            font-style: italic;
            margin-top: 16px;
            min-height: 1.5em;
            transition: opacity 0.6s ease;
        }

        .quote-message.visible {
            opacity: 0.7;
        }

        .warning-message {
            color: #ffd700;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üéÅ</div>
        <h1>Analyzing {% if recipient_type == 'someone_else' %}Their{% else %}Your{% endif %} Interests...</h1>
        <p class="subtitle">Hang tight ‚Äî this takes about a minute</p>

        <div class="platforms-analyzing">
            <h3 style="margin-bottom: 20px;">Getting to know {% if recipient_type == 'someone_else' %}them{% else %}you{% endif %} from:</h3>
            {% for platform in platforms %}
            <div class="platform-item">
                {% if platform == 'instagram' %}üì∑ Instagram{% endif %}
                {% if platform == 'spotify' %}üéµ Spotify{% endif %}
                {% if platform == 'pinterest' %}üìå Pinterest{% endif %}
                {% if platform == 'tiktok' %}üé¨ TikTok{% endif %}
                <span>‚úì</span>
            </div>
            {% endfor %}
        </div>

        <div class="spinner"></div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="status-message" id="statusMessage">Building a personality profile from their posts...</p>
        <p class="quote-message" id="quoteMessage"></p>
    </div>
    
    <script>
        (function() {
            'use strict';

            const progressBar = document.getElementById('progressBar');
            const statusEl = document.getElementById('statusMessage');
            const quoteEl = document.getElementById('quoteMessage');
            if (!progressBar) return;

            progressBar.classList.add('indeterminate');
            progressBar.style.width = '100%';

            // Pipeline stages ‚Äî shown in order, timed to roughly match real progress
            const stages = [
                { at: 0,   text: 'Building a personality profile from their posts...' },
                { at: 12,  text: 'Identifying interests, passions, and hidden obsessions...' },
                { at: 25,  text: 'Searching retailers for products they\'d actually love...' },
                { at: 45,  text: 'Browsing thousands of products across multiple stores...' },
                { at: 65,  text: 'AI is handpicking the perfect gifts...' },
                { at: 90,  text: 'Curating experiences they\'ll never forget...' },
                { at: 110, text: 'Validating every link and image...' },
                { at: 125, text: 'Almost there ‚Äî putting the finishing touches on...' },
            ];

            // Quotes ‚Äî cycled between stage updates to keep the page alive
            const quotes = [
                'Better than asking "what do you want?"',
                'No gift cards. No generic ideas. Real gifts.',
                'We do the hard part so you don\'t have to.',
                'Every recommendation backed by their actual interests.',
                'Searching stores you\'d never think to check.',
                'The best gifts feel like someone really gets you.',
                'Great gifts come to those who wait.',
                'This beats wandering the mall for three hours.',
                'Your recipient has no idea what\'s coming.',
                'Thousands of products. Only the perfect ones make the cut.',
            ];

            const state = {
                startTime: Date.now(),
                stageIndex: 0,
                quoteIndex: Math.floor(Math.random() * quotes.length),
                apiComplete: false,
            };

            function fadeText(el, newText) {
                el.style.opacity = '0';
                setTimeout(() => {
                    el.textContent = newText;
                    el.style.opacity = '';
                    el.classList.add('visible');
                }, 400);
            }

            function tick() {
                if (state.apiComplete) return;
                const elapsed = (Date.now() - state.startTime) / 1000;

                // Advance to next stage if it's time
                const nextStage = stages[state.stageIndex + 1];
                if (nextStage && elapsed >= nextStage.at) {
                    state.stageIndex++;
                    fadeText(statusEl, stages[state.stageIndex].text);
                }

                // Cycle quotes every 7 seconds
                if (quoteEl) {
                    const quotePhase = Math.floor(elapsed / 7);
                    const targetQuote = (state.quoteIndex + quotePhase) % quotes.length;
                    const currentText = quotes[targetQuote];
                    if (quoteEl.textContent !== currentText) {
                        fadeText(quoteEl, currentText);
                    }
                }

                // Warning if over 3 minutes
                if (elapsed >= 180) {
                    statusEl.innerHTML = 'This is taking longer than usual ‚Äî hang in there...';
                    statusEl.className = 'status-message warning-message';
                }
            }

            const tickInterval = setInterval(tick, 2000);
            // Show first quote after a short delay
            setTimeout(() => fadeText(quoteEl, quotes[state.quoteIndex]), 3000);

            window.giftwiseCleanup = function() {
                clearInterval(tickInterval);
                state.apiComplete = true;
            };
            window.giftwiseProgressState = state;
        })();
        
        // Auto-generate recommendations when page loads
        window.addEventListener('load', async function() {
            try {
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 240000); // 4 minute timeout (reduced from 6)
                
                const response = await fetch('/api/generate-recommendations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Cleanup progress tracking
                if (window.giftwiseCleanup) {
                    window.giftwiseCleanup();
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Mark API as complete
                    if (window.giftwiseProgressState) {
                        window.giftwiseProgressState.apiComplete = true;
                    }
                    
                    // Remove indeterminate animation and show complete
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.classList.remove('indeterminate');
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'white';
                        progressBar.setAttribute('data-progress', '100');
                    }
                    setTimeout(() => {
                        window.location.href = '/recommendations';
                    }, 500);
                } else {
                    if (window.giftwiseCleanup) {
                        window.giftwiseCleanup();
                    }
                    alert('Error generating recommendations: ' + (data.error || 'Unknown error'));
                    window.location.href = '/connect-platforms';
                }
            } catch (error) {
                if (window.giftwiseCleanup) {
                    window.giftwiseCleanup();
                }
                console.error('Error:', error);
                
                if (error.name === 'AbortError') {
                    alert('Request timed out. The AI is taking longer than expected. Please try again.');
                } else {
                    alert('Error generating recommendations. Please try again.');
                }
                window.location.href = '/connect-platforms';
            }
        });
    </script>
</body>
</html>
