<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Gift Recommendations - Giftwise</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.6em;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 0 20px;
        }
        
        .page-title {
            font-size: 2.5em;
            margin-bottom: 12px;
            color: #1f2937;
            text-align: center;
        }
        
        .page-subtitle {
            color: #6b7280;
            margin-bottom: 40px;
        }
        .retailer-attribution {
            margin: 0 0 24px 0;
            padding: 10px 15px;
            background: #f8f9fa;
            border-left: 3px solid #0066cc;
            border-radius: 4px;
        }
        .retailer-note {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }
        .retailer-note strong {
            color: #333;
            font-weight: 600;
            font-size: 1.15em;
            text-align: center;
        }
        
        /* Filters Section */
        .filters-section {
            background: white;
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }
        
        .filters-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-button {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s;
            color: #6b7280;
        }
        
        .filter-button:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .filter-button.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .price-slider {
            margin-top: 10px;
        }
        
        .price-range-display {
            color: #667eea;
            font-weight: 600;
            margin-top: 8px;
            font-size: 1.1em;
        }
        
        input[type="range"] {
            width: 100%;
            margin-top: 10px;
        }
        
        /* Recommendations Grid */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }
        
        @media (min-width: 1200px) {
            .recommendations-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        .recommendation-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: pointer;
        }
        
        .recommendation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        /* --- Focused card overlay (Apple Watch orbit) --- */
        .card-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.35s ease;
        }
        .card-backdrop.visible { display: block; opacity: 1; }

        .recommendation-card.focused {
            position: fixed;
            z-index: 101;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            width: min(580px, 92vw);
            max-height: 88vh;
            overflow-y: auto;
            border-radius: 20px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.35);
            border-color: #667eea;
            padding: 24px;
            animation: cardFocusIn 0.35s ease forwards;
            cursor: default;
        }

        @keyframes cardFocusIn {
            from { opacity: 0.7; transform: translate(-50%, -50%) scale(0.85); }
            to   { opacity: 1;   transform: translate(-50%, -50%) scale(1); }
        }

        /* Siblings shrink while one is focused */
        .recommendations-grid.has-focus .recommendation-card:not(.focused) {
            transform: scale(0.92);
            opacity: 0.45;
            filter: blur(1px);
            pointer-events: none;
            transition: all 0.35s ease;
        }

        .recommendation-card.expanded {
            padding: 20px;
        }
        
        .rec-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .rec-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
        }
        
        .rec-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .badge.safe-bet {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge.adventurous {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge.physical {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge.experience {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge.bookable {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .badge.diy {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            font-size: 0.8em;
            margin-left: 8px;
        }
        
        .rec-image-container {
            width: 100%;
            height: 200px;
            margin-bottom: 0;
            border-radius: 0;
            overflow: hidden;
            background: #f3f4f6;
            position: relative;
        }
        
        .recommendation-card.expanded .rec-image-container,
        .recommendation-card.focused .rec-image-container {
            height: 250px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .rec-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .recommendation-card:hover .rec-image {
            transform: scale(1.05);
        }
        
        .rec-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 3em;
        }
        
        .rec-image-fallback-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .rec-compact-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .rec-expanded-view {
            display: none;
        }
        
        .recommendation-card.expanded .rec-compact-view,
        .recommendation-card.focused .rec-compact-view {
            display: none;
        }

        .recommendation-card.expanded .rec-expanded-view,
        .recommendation-card.focused .rec-expanded-view {
            display: block;
        }
        
        .rec-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0;
            padding: 12px 15px;
            line-height: 1.4;
        }
        
        .recommendation-card.expanded .rec-name,
        .recommendation-card.focused .rec-name {
            font-size: 1.5em;
            margin-bottom: 15px;
            padding: 0;
        }
        
        .rec-description {
            display: none;
        }
        
        .recommendation-card.expanded .rec-description,
        .recommendation-card.focused .rec-description {
            display: block;
            color: #4b5563;
            line-height: 1.7;
            margin-bottom: 15px;
            font-size: 1.05em;
        }
        
        .rec-why {
            display: none;
        }
        
        .recommendation-card.expanded .rec-why,
        .recommendation-card.focused .rec-why {
            display: block;
            background: #f0fdf4;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #10b981;
            margin-bottom: 15px;
            color: #065f46;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .expand-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .recommendation-card:hover .expand-indicator {
            opacity: 1;
        }
        
        .recommendation-card.expanded .expand-indicator,
        .recommendation-card.focused .expand-indicator {
            display: none;
        }
        
        .rec-footer {
            display: none;
        }
        
        .recommendation-card.expanded .rec-footer,
        .recommendation-card.focused .rec-footer {
            display: block;
            margin-top: auto;
            padding-top: 15px;
            border-top: 2px solid #f3f4f6;
        }
        
        .rec-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 2px solid #f3f4f6;
        }
        
        .rec-price {
            font-size: 1.3em;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 10px;
        }
        
        .rec-where {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 12px;
        }
        
        .rec-link {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .rec-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .rec-link.disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .rec-link.disabled:hover {
            transform: none;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 1.2em;
        }
        
        /* Actions Section */
        .actions-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 50px 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-top: 50px;
        }
        
        .actions-title {
            font-size: 2em;
            margin-bottom: 15px;
            color: #1f2937;
        }
        
        .actions-description {
            color: #6b7280;
            margin-bottom: 35px;
            font-size: 1.15em;
        }
        
        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            border: none;
        }
        
        .action-button.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .action-button.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.3);
        }
        
        .action-button.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .action-button.secondary:hover {
            background: #667eea;
            color: white;
        }
        
        /* Close button on focused card */
        .card-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            z-index: 102;
            line-height: 36px;
            text-align: center;
        }
        .recommendation-card.focused .card-close-btn { display: block; }

        @media (max-width: 768px) {
            .recommendation-card.focused {
                width: 96vw;
                max-height: 92vh;
                border-radius: 16px;
            }
            .recommendations-grid {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 2em;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .action-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üéÅ Giftwise</div>
            <div style="opacity: 0.95;">Your Personalized Recommendations</div>
        </div>
    </div>
    
    <!-- Valentine's Day urgency banner (auto-hides when not relevant) -->
    <div id="vday-banner" style="display:none; background: linear-gradient(135deg, #f43f5e, #be123c); color: white; text-align: center; padding: 10px 20px; font-size: 14px; font-weight: 600;">
        <span id="vday-msg"></span>
        <a href="/valentine" style="color: white; margin-left: 12px; text-decoration: underline;">Valentine's Gift Guide</a>
    </div>
    <script>
    (function() {
        var vday = new Date('2026-02-14T00:00:00');
        var now = new Date();
        var days = Math.floor((vday - now) / 86400000);
        if (days >= 0 && days <= 14) {
            var msg = days === 0 ? "Valentine's Day is TODAY! Order ASAP." :
                      days === 1 ? "TOMORROW is Valentine's Day! Order now." :
                      days <= 3 ? days + " days until Valentine's Day ‚Äî order now for delivery!" :
                      days + " days until Valentine's Day";
            document.getElementById('vday-msg').textContent = msg;
            document.getElementById('vday-banner').style.display = 'block';
        }
    })();
    </script>

    <div class="container">
        <h1 class="page-title">Your Gift Recommendations</h1>
        <p class="page-subtitle">Based on social media insights ‚Ä¢ {{ recommendations|length }} gifts found</p>

        <!-- Early Access Reality Check -->
        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 16px; padding: 24px; margin-bottom: 30px;">
            <div style="display: flex; align-items: start; gap: 16px;">
                <div style="font-size: 32px; flex-shrink: 0;">üöß</div>
                <div>
                    <h3 style="font-size: 18px; font-weight: 700; color: #92400e; margin-bottom: 8px;">You're early. Here's what that means:</h3>
                    <p style="color: #78350f; line-height: 1.6; margin-bottom: 12px;">
                        Right now, we're pulling from <strong>Amazon + eBay</strong>. That's it. We've got applications pending with Etsy, Skimlinks (48,500 retailers), Awin (Lululemon, UGG, boutique brands), and a dozen other networks. The AI works. We're just waiting on approvals.
                    </p>
                    <p style="color: #78350f; line-height: 1.6; margin-bottom: 12px;">
                        <strong>Translation:</strong> Some picks will be great. Some will feel generic. That's the reality of thin inventory, not bad AI.
                    </p>
                    <p style="color: #78350f; line-height: 1.6; font-weight: 600;">
                        <strong>Why you should try it anyway:</strong> Every search you run tells us which retailers to chase first. The more people use it, the faster we unlock the good stuff. You're not just getting recommendations ‚Äî you're helping build this.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-title">üîç Filter Recommendations</div>
            <div class="filters-grid">
                <!-- Price Filter -->
                <div class="filter-group">
                    <div class="filter-label">Price Range</div>
                    <div class="filter-buttons">
                        <button class="filter-button active" data-filter-type="price" data-filter-value="all">All Prices</button>
                        <button class="filter-button" data-filter-type="price" data-filter-value="20-50">$20-50</button>
                        <button class="filter-button" data-filter-type="price" data-filter-value="50-100">$50-100</button>
                        <button class="filter-button" data-filter-type="price" data-filter-value="100-200">$100-200</button>
                    </div>
                </div>
                
                <!-- Gift Type Filter -->
                <div class="filter-group">
                    <div class="filter-label">Gift Type</div>
                    <div class="filter-buttons">
                        <button class="filter-button active" data-filter-type="type" data-filter-value="all">All Types</button>
                        <button class="filter-button" data-filter-type="type" data-filter-value="physical">Physical</button>
                        <button class="filter-button" data-filter-type="type" data-filter-value="experience">Experience</button>
                    </div>
                </div>
                
                <!-- Confidence Filter -->
                <div class="filter-group">
                    <div class="filter-label">Confidence Level</div>
                    <div class="filter-buttons">
                        <button class="filter-button active" data-filter-type="confidence" data-filter-value="all">All Levels</button>
                        <button class="filter-button" data-filter-type="confidence" data-filter-value="safe_bet">Safe Bet</button>
                        <button class="filter-button" data-filter-type="confidence" data-filter-value="adventurous">Adventurous</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Backdrop for focused card overlay -->
        <div class="card-backdrop" id="card-backdrop"></div>

        <!-- Recommendations Grid -->
        <div class="recommendations-grid" id="recommendations-grid">
            {% for rec in recommendations %}
            <div class="recommendation-card" 
                 data-price="{{ rec.price_range }}"
                 data-type="{{ rec.gift_type }}"
                 data-confidence="{{ rec.confidence_level }}"
                 onclick="toggleCard(this)">
                <button class="card-close-btn" onclick="event.stopPropagation(); closeCard();" aria-label="Close">&times;</button>
                <!-- Compact View -->
                <div class="rec-compact-view">
                    <div class="rec-image-container">
                        {% if rec.image_url %}
                        <img src="{{ rec.image_url }}" 
                             alt="{{ rec.name }}" 
                             class="rec-image"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="rec-image-placeholder" style="display: none;">üéÅ</div>
                        {% else %}
                        <div class="rec-image-placeholder">üéÅ</div>
                        {% endif %}
                        <div class="expand-indicator">Click to expand</div>
                    </div>
                    <h2 class="rec-name">{{ rec.name }}</h2>
                </div>
                
                <!-- Expanded View -->
                <div class="rec-expanded-view">
                    <div class="rec-header">
                        <div class="rec-number">{{ loop.index }}</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div class="rec-badges">
                                <span class="badge {{ rec.confidence_level|replace('_', '-') }}">
                                    {{ 'Safe Bet' if rec.confidence_level == 'safe_bet' else 'Adventurous' }}
                                </span>
                                <span class="badge {{ rec.gift_type }}">
                                    {{ rec.gift_type|capitalize }}
                                </span>
                                {% if rec.gift_type == 'experience' %}
                                    {% if rec.reservation_link or rec.venue_website or rec.experience_providers %}
                                    <span class="badge bookable">üìÖ Book</span>
                                    {% elif rec.materials_needed %}
                                    <span class="badge diy">üõ†Ô∏è Plan</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <button onclick="event.stopPropagation(); toggleFavorite({{ loop.index0 }}, this)" 
                                    class="favorite-btn {% if loop.index0 in favorites %}favorited{% endif %}"
                                    title="Save to favorites">
                                ‚ù§Ô∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="rec-image-container">
                        {% if rec.image_url %}
                        <img src="{{ rec.image_url }}" 
                             alt="{{ rec.name }}" 
                             class="rec-image"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="rec-image-placeholder" style="display: none;">üéÅ</div>
                        {% else %}
                        <div class="rec-image-placeholder">üéÅ</div>
                        {% endif %}
                    </div>
                    
                    <h2 class="rec-name">{{ rec.name }}</h2>
                    <p class="rec-description">{{ rec.description }}</p>
                    <div class="rec-why">
                        <strong>Why it's perfect for {{ 'you' if user.recipient_type == 'myself' else 'them' }}:</strong> {{ rec.why_perfect }}
                    </div>
                    {% if rec.gift_type == 'experience' and rec.materials_needed %}
                    <p style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">Shopping list (click to get items):</p>
                    <div class="rec-materials" style="margin: 12px 0; padding: 10px; background: #f8fafc; border-radius: 8px;">
                        <strong>What you'll need (click to get):</strong>
                        <ul style="margin: 6px 0 0 0; padding: 0; list-style: none;">
                        {% for m in rec.materials_needed[:5] %}
                            <li style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
                                {% if m.thumbnail %}
                                <img src="{{ m.thumbnail }}" alt="{{ m.item }}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; flex-shrink: 0;" onerror="this.style.display='none'">
                                {% endif %}
                                <div style="flex: 1;">
                                    {% if m.product_url %}
                                    <a href="{{ m.product_url }}" target="_blank" onclick="event.stopPropagation(); trackClick('{{ m.product_url }}', 'material');" style="color: #be123c; font-weight: 500; text-decoration: none;">{{ m.item }}</a>{% if m.is_search_link %}<span style="color: #6b7280; font-size: 0.85em;"> ‚Äî find online</span>{% endif %}
                                    {% else %}
                                    <span style="font-weight: 500;">{{ m.item }}</span>
                                    {% endif %}
                                    {% if m.estimated_price %}<span style="color: #6b7280; font-size: 0.9em;"> {{ m.estimated_price }}</span>{% endif %}
                                    {% if m.where_to_buy and not m.is_search_link %}<span style="color: #9ca3af; font-size: 0.85em;"> ‚Äî {{ m.where_to_buy }}</span>{% endif %}
                                </div>
                            </li>
                        {% endfor %}
                        </ul>
                        <a href="/recommendations/experience/{{ loop.index0 }}" onclick="event.stopPropagation();" class="rec-link" style="display: inline-block; margin-top: 8px;">View full experience ‚Üí</a>
                    </div>
                    {% elif rec.gift_type == 'experience' %}
                    <div style="margin: 8px 0;">
                        <a href="/recommendations/experience/{{ loop.index0 }}" onclick="event.stopPropagation();" class="rec-link" style="display: inline-block;">View full experience ‚Üí</a>
                    </div>
                    {% endif %}
                    <div class="rec-footer">
                        <div class="rec-price">{{ rec.price_range }}</div>
                        <div class="rec-where">Available at: {{ rec.where_to_buy }}</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% if rec.gift_type == 'experience' %}
                            {% if rec.reservation_link %}
                            <a href="{{ rec.reservation_link }}" target="_blank" class="rec-link" onclick="event.stopPropagation(); trackClick('{{ rec.reservation_link }}', 'reservation');" style="background: #059669;">
                                Reserve / Book ‚Üí
                            </a>
                            {% endif %}
                            {% if rec.venue_website %}
                            <a href="{{ rec.venue_website }}" target="_blank" class="rec-link secondary" onclick="event.stopPropagation();">
                                Venue / Website
                            </a>
                            {% endif %}
                            {% if rec.experience_providers and not rec.reservation_link %}
                            {% for provider in rec.experience_providers[:2] %}
                            <a href="{{ provider.url }}" target="_blank" class="rec-link" onclick="event.stopPropagation(); trackClick('{{ provider.url }}', 'provider');" style="background: #7c3aed;">
                                {{ provider.name }} ‚Üí
                            </a>
                            {% endfor %}
                            {% elif rec.purchase_link and (rec.experience_search_fallback or (not rec.reservation_link and not rec.venue_website)) %}
                            <a href="{{ rec.purchase_link }}" target="_blank" class="rec-link" onclick="event.stopPropagation(); trackClick('{{ rec.purchase_link }}', 'experience');" style="background: #0ea5e9;">
                                Find options ‚Üí
                            </a>
                            {% endif %}
                            {% endif %}
                            {% if rec.gift_type == 'physical' and rec.purchase_link %}
                            <a href="{{ rec.purchase_link }}" target="_blank" class="rec-link" onclick="event.stopPropagation(); trackClick('{{ rec.purchase_link }}', 'physical');">
                                Shop Now ‚Üí
                            </a>
                            <button onclick="event.stopPropagation(); copyLink('{{ rec.purchase_link }}', this)" class="rec-link" style="background: #6b7280; cursor: pointer; border: none;">
                                üìã Copy Link
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="no-results" id="no-results" style="display: none;">
            No recommendations match your current filters. Try adjusting your selection!
        </div>
        
        <!-- Share Section -->
        <div class="share-section" style="margin: 40px auto; max-width: 700px; text-align: center;">
            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 2px solid #0ea5e9; border-radius: 16px; padding: 30px;">
                <h3 style="font-size: 22px; color: #0369a1; margin-bottom: 8px;">Share these picks with someone</h3>
                <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Send your personalized recommendations to a friend, partner, or family member</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="shareRecommendations()" class="action-button primary" style="border: none; cursor: pointer; background: linear-gradient(135deg, #0ea5e9, #0369a1); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600;">
                        Share My Picks
                    </button>
                    <button onclick="shareToTwitter()" class="action-button secondary" style="border: none; cursor: pointer; background: #1da1f2; color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600;">
                        Share on X
                    </button>
                </div>
                <div id="share-result" style="display: none; margin-top: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <input id="share-url" type="text" readonly style="padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; width: 320px; max-width: 80vw; background: white;">
                        <button onclick="copyShareUrl()" style="padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Copy</button>
                    </div>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 8px;">Anyone with this link can see your recommendations</p>
                </div>
            </div>
        </div>

        <!-- Actions Section -->
        <div class="actions-section">
            <h2 class="actions-title">What's Next?</h2>
            <p class="actions-description">Help us improve Giftwise with your feedback!</p>
            <div class="button-group">
                <a href="/feedback" class="action-button primary">Give Feedback</a>
                <a href="/connect-platforms" class="action-button secondary">Update Platforms</a>
                <a href="/generate-recommendations" class="action-button secondary">Regenerate</a>
                <button onclick="copyAllLinks()" class="action-button secondary" style="border: none; cursor: pointer;">
                    üìã Copy All Links
                </button>
            </div>
        </div>
        </div>
        
        <script>
        // Track outbound product clicks (fire-and-forget, non-blocking)
        function trackClick(url, source) {
            fetch('/api/track-click', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url, source: source || 'physical'})
            }).catch(() => {});
        }

        // Copy link to clipboard
        function copyLink(url, button) {
            navigator.clipboard.writeText(url).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#6b7280';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy link. Please copy manually: ' + url);
            });
        }
        
        // Copy all links
        function copyAllLinks() {
            const links = Array.from(document.querySelectorAll('.rec-link[href]'))
                .map(link => link.href)
                .filter(href => href && !href.includes('javascript:'));
            
            if (links.length === 0) {
                alert('No links available to copy');
                return;
            }
            
            const linksText = links.join('\n');
            navigator.clipboard.writeText(linksText).then(() => {
                alert(`Copied ${links.length} links to clipboard!`);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy links');
            });
        }
        
        // Share recommendations
        function shareRecommendations() {
            fetch('/api/share', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('share-url').value = data.share_url;
                    document.getElementById('share-result').style.display = 'block';
                    navigator.clipboard.writeText(data.share_url).catch(() => {});
                } else {
                    alert(data.error || 'Could not create share link');
                }
            })
            .catch(() => alert('Could not create share link. Try again?'));
        }

        function copyShareUrl() {
            const url = document.getElementById('share-url').value;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
            });
        }

        function shareToTwitter() {
            // Create share link first, then open Twitter with it
            fetch('/api/share', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('share-url').value = data.share_url;
                    document.getElementById('share-result').style.display = 'block';
                    const text = "Just found the perfect gifts with AI! Check out what Giftwise picked:";
                    const twitterUrl = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text) + '&url=' + encodeURIComponent(data.share_url);
                    window.open(twitterUrl, '_blank', 'width=550,height=420');
                }
            })
            .catch(() => alert('Could not create share link'));
        }

        // Toggle favorite (save/unsave)
        function toggleFavorite(index, button) {
            fetch('/api/toggle-favorite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.classList.toggle('favorited');
                    if (data.favorited) {
                        button.style.transform = 'scale(1.2)';
                        setTimeout(() => button.style.transform = 'scale(1)', 200);
                    }
                }
            })
            .catch(err => console.error('Error toggling favorite:', err));
        }
        
        // --- Orbit card expansion ---
        const backdrop = document.getElementById('card-backdrop');
        const grid = document.getElementById('recommendations-grid');
        let focusedCard = null;

        function openCard(card) {
            if (focusedCard === card) { closeCard(); return; }
            if (focusedCard) closeCard(true);

            // Remember scroll position for the card
            card._scrollY = window.scrollY;
            focusedCard = card;
            card.classList.add('focused');
            grid.classList.add('has-focus');
            backdrop.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeCard(skipBodyReset) {
            if (!focusedCard) return;
            focusedCard.classList.remove('focused');
            focusedCard = null;
            grid.classList.remove('has-focus');
            backdrop.classList.remove('visible');
            if (!skipBodyReset) document.body.style.overflow = '';
        }

        function toggleCard(card) {
            openCard(card);
        }

        // Close on backdrop click
        backdrop.addEventListener('click', function() { closeCard(); });

        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && focusedCard) closeCard();
        });
    </script>
    
    <script>
        // Filtering Logic
        const filterButtons = document.querySelectorAll('.filter-button');
        const recommendationCards = document.querySelectorAll('.recommendation-card');
        const noResultsMessage = document.getElementById('no-results');
        
        let activeFilters = {
            price: 'all',
            type: 'all',
            confidence: 'all'
        };
        
        // Parse price range for filtering
        function parsePriceRange(priceString) {
            const match = priceString.match(/\$(\d+)-\$(\d+)/);
            if (match) {
                return {
                    min: parseInt(match[1]),
                    max: parseInt(match[2])
                };
            }
            return null;
        }
        
        // Check if card matches current filters
        function cardMatchesFilters(card) {
            const cardPrice = card.dataset.price;
            const cardType = card.dataset.type;
            const cardConfidence = card.dataset.confidence;
            
            // Price filter
            if (activeFilters.price !== 'all') {
                const [minPrice, maxPrice] = activeFilters.price.split('-').map(Number);
                const range = parsePriceRange(cardPrice);
                
                if (range) {
                    // Check if there's any overlap between filter range and card range
                    if (range.max < minPrice || range.min > maxPrice) {
                        return false;
                    }
                }
            }
            
            // Type filter
            if (activeFilters.type !== 'all' && cardType !== activeFilters.type) {
                return false;
            }
            
            // Confidence filter
            if (activeFilters.confidence !== 'all' && cardConfidence !== activeFilters.confidence) {
                return false;
            }
            
            return true;
        }
        
        // Apply filters
        function applyFilters() {
            let visibleCount = 0;
            
            recommendationCards.forEach(card => {
                if (cardMatchesFilters(card)) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            if (visibleCount === 0) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }
        }
        
        // Handle filter button clicks
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filterType = this.dataset.filterType;
                const filterValue = this.dataset.filterValue;
                
                // Update active filters
                activeFilters[filterType] = filterValue;
                
                // Update button states
                const siblingButtons = this.parentElement.querySelectorAll('.filter-button');
                siblingButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Apply filters
                applyFilters();
            });
        });
    </script>
    <script type="text/javascript" src="https://s.skimresources.com/js/298548X178612"></script>
</body>
</html>
